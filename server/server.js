const express = require('express');
const mongoose = require('mongoose');
const cookieParser = require('cookie-parser');
const cors = require('cors');
require('dotenv').config();

const app = express();
const fs = require('fs');
const path = require('path');


try {
const mdir = path.join(__dirname, 'models');
const rdir = path.join(__dirname, 'routes');
console.log('[BOOT] cwd =', process.cwd());
console.log('[BOOT] __dirname =', __dirname);
console.log('[BOOT] server/models exists?', fs.existsSync(mdir));
if (fs.existsSync(mdir)) console.log('[BOOT] server/models list:', fs.readdirSync(mdir));
console.log('[BOOT] server/routes exists?', fs.existsSync(rdir));
if (fs.existsSync(rdir)) console.log('[BOOT] server/routes list:', fs.readdirSync(rdir));
} catch (e) {
console.log('[BOOT] dir check error:', e);
}

app.set('trust proxy', 1); // Required for Render + Secure Cookies

// â”€â”€â”€ MIDDLEWARE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.use(express.json());
app.use(cookieParser());

// â”€â”€â”€ CORS SETUP FOR RENDER DEPLOYMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.use(cors({
  origin: 'https://pipetrack.onrender.com', // Frontend on Render
  credentials: true,
}));

// â”€â”€â”€ ROUTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const authRoutes     = require('./routes/auth');
const partsRoutes    = require('./routes/parts');
const barcodesRoutes = require('./routes/barcodes');
const jobsRoutes     = require('./routes/jobs');

// Use only relative paths, not full URLs
app.use('/api/auth', authRoutes);
app.use('/api/parts', partsRoutes);
app.use('/api/barcodes', barcodesRoutes);
app.use('/api/jobs', jobsRoutes);

app.use((err, req, res, next) => {
  console.error('Unhandled error:', err);
  res.status(500).json({ message: 'Server error' });
});

// â”€â”€â”€ ROOT ROUTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.get('/', (req, res) => {
  res.send('ðŸš€ PipeTrack backend is running in production!');
});

// â”€â”€â”€ DATABASE CONNECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
mongoose.connect(process.env.MONGO_URI)
  .then(() => console.log('âœ… MongoDB connected'))
  .catch(err => console.error('âŒ MongoDB connection error:', err));

// â”€â”€â”€ START SERVER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PORT = process.env.PORT || 5001;
app.listen(PORT, '0.0.0.0', () => {
  console.log(`ðŸš€ Server running on port ${PORT}`);
});
